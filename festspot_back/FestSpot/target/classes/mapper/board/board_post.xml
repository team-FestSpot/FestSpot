<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.festspot.dev.domain.post.BoardPostMapper">

    <select id="findCategoryByKey" resultType="int">
        select
            post_category_id
        from
            post_category_tb
        where
            post_category_key = #{key}
        limit
            1
    </select>

    <select id="countPostByCategory" resultType="int">
        select
            count(*)
        from
            post_tb
        where
            post_category_id = #{categoryId}
    </select>

    <select id="selectPostByCategory" resultType="com.festspot.dev.dto.post.BoardListItemDto">
        select
            *
        from
            post_tb pt
            left outer join post_category_tb pct on(pct.post_category_id = pt.post_category_id)
            left outer join post_img_tb pit on(pit.post_id = pt.post_id)
            left outer join user_tb ut on(ut.user_id = pt.original_poster_id)
        where
            (pt.post_category_id = #{categoryId});
    </select>

    <insert id="insertPost" parameterType="com.festspot.dev.domain.post.Post" useGeneratedKeys="true" keyProperty="postId">
        insert into post_tb
        values (#{originalPosterId}, #{postCategoryId}, #{postTitle}, #{postContent}, #{allowComments}, 0, 0, 0, NOW(), NOW())
    </insert>

    <insert id="insertPostImages">
        insert into post_img_tb
        values
            <foreach collection="images" item="img" separator=",">
                (#{img.postId}, #{img.postImgUrl}, #{img.seq}, now())
            </foreach>
    </insert>

    <select id="lastInsertId" resultType="int">
        select LAST_INSERT_ID()
    </select>

    <select id="getPostAll" resultType="com.festspot.dev.dto.post.PostDetailDto">
        select
            *
        from
            post_tb pt
            left outer join post_category_tb pct on(pct.post_category_id = pt.post_category_id)
            left outer join post_img_tb pit on(pit.post_id = pt.post_id)
            left outer join user_tb ut on(ut.user_id = pt.original_poster_id)
    </select>

    <select id="selectPostById" resultType="com.festspot.dev.dto.post.PostDetailDto">
        SELECT
            pt.post_id,
            pct.post_category_key,
            pt.post_title,
            pt.post_content,
            pt.original_poster_id,
            ut.user_nickname,
            pt.allow_comments,
            pt.view_count,
            pt.like_count,
            pt.comment_count,
            pt.created_at,
            pt.updated_at
        FROM post_tb pt
            JOIN post_category_tb pct ON pct.post_category_id = pt.post_category_id
            LEFT JOIN user_tb ut ON ut.user_id = pt.original_poster_id
        WHERE pt.post_id = #{postId}
        LIMIT 1;
    </select>

    <select id="selectPostImages" resultType="com.festspot.dev.dto.post.PostDetailDto$PostImgDto">
        select
            pit.post_img_id,
            pit.post_img_url,
            pit.seq
        from
            post_img_tb pit
        where
            pit.post_id = #{postId}
        order by
            seq ASC
    </select>
</mapper>