<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.festspot.dev.domain.performance.PerformanceMapper">
  <resultMap id="PerformanceMap" type="com.festspot.dev.domain.performance.Performance">
    <id column="performance_id" property="performanceId" />
    <result column="performance_api_id" property="performanceApiId" />
    <result column="performance_title" property="performanceTitle" />
    <result column="performance_cast" property="performanceCast" />
    <result column="performance_poster_url" property="performancePosterUrl" />
    <result column="performance_start_date" property="performanceStartDate" />
    <result column="performance_end_date" property="performanceEndDate" />
    <result column="performance_venue" property="performanceVenue" />
    <result column="performance_last_modified" property="performanceLastModified" />
    <result column="is_foreign" property="isForeign" />
    <result column="is_festival" property="isFestival" />
    <result column="updated_at" property="updatedAt" />
    <association property="performanceRegion" resultMap="PerformanceRegionMap" />
    <association property="performanceState" resultMap="PerformanceStateMap" />
    <collection javaType="list" property="ticketingUrls" resultMap="TicketingUrlMap" />
  </resultMap>
  <resultMap id="PerformanceRegionMap" type="com.festspot.dev.domain.performance.performanceRegion.PerformanceRegion">
    <id column="performance_region_id" property="performanceRegionId" />
    <result column="region_code" property="regionCode" />
    <result column="region_name" property="regionName" />
  </resultMap>
  <resultMap id="PerformanceStateMap" type="com.festspot.dev.domain.performance.performanceState.PerformanceState">
    <id column="performance_state_id" property="performanceStateId" />
    <result column="performance_state" property="performanceState" />
  </resultMap>
  <resultMap id="TicketingUrlMap" type="com.festspot.dev.domain.ticketing.TicketingUrl">
    <id column="ticketing_url_id" property="ticketingUrlId" />
    <result column="performance_id" property="performanceId" />
    <result column="ticketing_url" property="ticketingUrl" />
    <result column="ticketing_agency_name" property="ticketingAgencyName" />
  </resultMap>

  <select id="findAll" resultMap="PerformanceMap">
    select
    *
    from
    performance_tb
  </select>
  <select id="findByPerformanceApiId" resultMap="PerformanceMap">
    select
    *
    from
    performance_tb
    where
    performance_api_id = #{performanceApiId}
  </select>
  <select id="findById" resultMap="PerformanceMap">
    select
    *
    from
    performance_tb
    where
    performance_id = #{performanceId}
  </select>

  <select id="findByPerformanceApiIdIsNull" resultType="com.festspot.dev.domain.performance.Performance">
    select
      *
    from
      performance_tb pt
      left outer join performance_region_tb prt
        on prt.performance_region_id = pt.performance_region_id
      left outer join performance_state_tb pst
        on pst.performance_state_id = pt.performance_state_id
      left outer join ticketing_url_tb tut
        on tut.performance_id = pt.performance_id
    where
      pt.performance_api_id is null
  </select>

    <insert id="insert" keyProperty="performanceId" useGeneratedKeys="true">
    insert ignore into performance_tb (
    performance_id,
    performance_region_id,
    performance_api_id,
    performance_title,
    performance_cast,
    performance_poster_url,
    performance_start_date,
    performance_end_date,
    performance_venue,
    performance_state_id,
    performance_last_modified,
    is_foreign,
    is_festival,
    updated_at
    )
    values (
    default,
    #{performanceRegion.performanceRegionId},
    #{performanceApiId},
    #{performanceTitle},
    #{performanceCast},
    #{performancePosterUrl},
    #{performanceStartDate},
    #{performanceEndDate},
    #{performanceVenue},
    #{performanceState.performanceStateId},
    #{performanceLastModified},
    #{isForeign},
    #{isFestival},
    #{updatedAt}
    )
  </insert>

  <insert id="insertMany" keyProperty="performanceId" parameterType="java.util.List" useGeneratedKeys="true">
    insert ignore into performance_tb (
    performance_id,
    performance_region_id,
    performance_api_id,
    performance_title,
    performance_cast,
    performance_poster_url,
    performance_start_date,
    performance_end_date,
    performance_venue,
    performance_state_id,
    performance_last_modified,
    is_foreign,
    is_festival,
    updated_at
    )
    values
    <foreach collection="list" index="index" item="performance" separator=",">
      (
      default,
      #{performance.performanceRegion.performanceRegionId},
      #{performance.performanceApiId},
      #{performance.performanceTitle},
      #{performance.performanceCast},
      #{performance.performancePosterUrl},
      #{performance.performanceStartDate},
      #{performance.performanceEndDate},
      #{performance.performanceVenue},
      #{performance.performanceState.performanceStateId},
      #{performance.performanceLastModified},
      #{performance.isForeign},
      #{performance.isFestival},
      #{performance.updatedAt}
      )
    </foreach>
  </insert>
</mapper>