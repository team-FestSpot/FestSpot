<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.festspot.dev.domain.performance.PerformanceMapper">
  <resultMap id="PerformanceMap" type="com.festspot.dev.domain.performance.Performance">
    <id column="performance_id" property="performanceId" />
    <result column="performance_api_id" property="performanceApiId" />
    <result column="performance_title" property="performanceTitle" />
    <result column="performance_cast" property="performanceCast" />
    <result column="performance_poster_url" property="performancePosterUrl" />
    <result column="performance_start_date" property="performanceStartDate" />
    <result column="performance_end_date" property="performanceEndDate" />
    <result column="performance_venue" property="performanceVenue" />
    <result column="performance_last_modified" property="performanceLastModified" />
    <result column="is_foreign" property="isForeign" />
    <result column="is_festival" property="isFestival" />
    <result column="updated_at" property="updatedAt" />
    <association property="performanceRegion" resultMap="PerformanceRegionMap" />
    <association property="performanceState" resultMap="PerformanceStateMap" />
    <collection javaType="list" property="ticketingUrls" resultMap="TicketingUrlMap" />
  </resultMap>
  <resultMap id="PerformanceRegionMap" type="com.festspot.dev.domain.performance.performanceRegion.PerformanceRegion">
    <id column="performance_region_id" property="performanceRegionId" />
    <result column="region_code" property="regionCode" />
    <result column="region_name" property="regionName" />
  </resultMap>
  <resultMap id="PerformanceStateMap" type="com.festspot.dev.domain.performance.performanceState.PerformanceState">
    <id column="performance_state_id" property="performanceStateId" />
    <result column="performance_state" property="performanceState" />
  </resultMap>
  <resultMap id="TicketingUrlMap" type="com.festspot.dev.domain.ticketing.TicketingUrl">
    <id column="ticketing_url_id" property="ticketingUrlId" />
    <result column="performance_id" property="performanceId" />
    <result column="ticketing_url" property="ticketingUrl" />
    <result column="ticketing_agency_name" property="ticketingAgencyName" />
  </resultMap>

<resultMap id="PerformanceCommentMap" type="com.festspot.dev.domain.performance.performanceComment.PerformanceComment">
    <id column="performance_comment_id" property="performanceCommentId" />
    <result column="pct_user_id" property="userId" />
    <result column="pct_performance_id" property="performanceId" />
    <result column="content" property="content" />
    <result column="pct_created_at" property="createdAt" />
    <result column="pct_deleted_at" property="deletedAt" />

    <association property="user" resultMap="com.festspot.dev.domain.user.UserMapper.UserMap" />
 </resultMap>

    <update id="update">
        update performance_tb
        set
            performance_region_id = #{performanceRegion.performanceRegionId},
            performance_title = #{performanceTitle},
            performance_cast= #{performanceCast},
            performance_poster_url = #{performancePosterUrl},
            performance_start_date = #{performanceStartDate},
            performance_end_date = #{performanceEndDate},
            performance_venue = #{performanceVenue},
            performance_state_id = #{performanceState.performanceStateId},
            performance_last_modified = #{performanceLastModified},
            is_foreign = #{isForeign},
            is_festival = #{isFestival},
            updated_at = #{updatedAt}
        where
            performance_id = #{performanceId}
    </update>

<!--    <update id="updateManyByApiIds">-->
<!--        <foreach collection="list" item="performance">-->
<!--            update-->
<!--                performance_tb-->
<!--            set-->
<!--                performance_region_id = #{performance.performanceRegion.performanceRegionId},-->
<!--                performance_title = #{performance.performanceTitle},-->
<!--                performance_cast= #{performance.performanceCast},-->
<!--                performance_poster_url = #{performance.performancePosterUrl},-->
<!--                performance_start_date = #{performance.performanceStartDate},-->
<!--                performance_end_date = #{performance.performanceEndDate},-->
<!--                performance_venue = #{performance.performanceVenue},-->
<!--                performance_state_id = #{performance.performanceState.performanceStateId},-->
<!--                performance_last_modified = #{performance.performanceLastModified},-->
<!--                is_foreign = #{performance.isForeign},-->
<!--                is_festival = #{performance.isFestival},-->
<!--                updated_at = #{performance.updatedAt}-->
<!--            where-->
<!--                performance_api_id = #{performance.performanceApiId}-->
<!--        </foreach>-->
<!--    </update>-->

    <update id="updateManyByApiIds">
        UPDATE performance_tb
        SET
        performance_region_id = CASE performance_api_id
        <foreach collection="list" item="performance">
            WHEN #{performance.performanceApiId} THEN #{performance.performanceRegion.performanceRegionId}
        </foreach>
        END,
        performance_title = CASE performance_api_id
        <foreach collection="list" item="performance">
            WHEN #{performance.performanceApiId} THEN #{performance.performanceTitle}
        </foreach>
        END,
        performance_cast = CASE performance_api_id
        <foreach collection="list" item="performance">
            WHEN #{performance.performanceApiId} THEN #{performance.performanceCast}
        </foreach>
        END,
        performance_poster_url = CASE performance_api_id
        <foreach collection="list" item="performance">
            WHEN #{performance.performanceApiId} THEN #{performance.performancePosterUrl}
        </foreach>
        END,
        performance_start_date = CASE performance_api_id
        <foreach collection="list" item="performance">
            WHEN #{performance.performanceApiId} THEN #{performance.performanceStartDate}
        </foreach>
        END,
        performance_end_date = CASE performance_api_id
        <foreach collection="list" item="performance">
            WHEN #{performance.performanceApiId} THEN #{performance.performanceEndDate}
        </foreach>
        END,
        performance_venue = CASE performance_api_id
        <foreach collection="list" item="performance">
            WHEN #{performance.performanceApiId} THEN #{performance.performanceVenue}
        </foreach>
        END,
        performance_state_id = CASE performance_api_id
        <foreach collection="list" item="performance">
            WHEN #{performance.performanceApiId} THEN #{performance.performanceState.performanceStateId}
        </foreach>
        END,
        performance_last_modified = CASE performance_api_id
        <foreach collection="list" item="performance">
            WHEN #{performance.performanceApiId} THEN #{performance.performanceLastModified}
        </foreach>
        END,
        is_foreign = CASE performance_api_id
        <foreach collection="list" item="performance">
            WHEN #{performance.performanceApiId} THEN #{performance.isForeign}
        </foreach>
        END,
        is_festival = CASE performance_api_id
        <foreach collection="list" item="performance">
            WHEN #{performance.performanceApiId} THEN #{performance.isFestival}
        </foreach>
        END,
        updated_at = CASE performance_api_id
        <foreach collection="list" item="performance">
            WHEN #{performance.performanceApiId} THEN #{performance.updatedAt}
        </foreach>
        END
        WHERE performance_api_id IN
        <foreach collection="list" item="performance" open="(" separator="," close=")">
            #{performance.performanceApiId}
        </foreach>
    </update>

    <delete id="deleteById">
        delete from performance_tb
        where performance_id = #{performanceId}
    </delete>

    <select id="findAll" resultMap="PerformanceMap">
    select
    *
    from
      performance_tb pt
      left outer join performance_region_tb prt on(prt.performance_region_id = pt.performance_region_id)
      left outer join performance_state_tb pst on(pst.performance_state_id = pt.performance_state_id)
      left outer join ticketing_url_tb tut on(tut.performance_id = pt.performance_id)
    order by
      pt.performance_start_date
  </select>
  <select id="findByPerformanceApiId" resultMap="PerformanceMap">
    select
        *
    from
      performance_tb pt
      left outer join performance_region_tb prt on(prt.performance_region_id = pt.performance_region_id)
      left outer join performance_state_tb pst on(pst.performance_state_id = pt.performance_state_id)
      left outer join ticketing_url_tb tut on(tut.performance_id = pt.performance_id)
    where
      pt.performance_api_id = #{performanceApiId}
  </select>
  <select id="findById" resultMap="PerformanceMap">
    select
        *
    from
      performance_tb pt
      left outer join performance_region_tb prt on(prt.performance_region_id = pt.performance_region_id)
      left outer join performance_state_tb pst on(pst.performance_state_id = pt.performance_state_id)
      left outer join ticketing_url_tb tut on(tut.performance_id = pt.performance_id)
    where
      pt.performance_id = #{performanceId}
  </select>

    <select id="findByPerformanceApiIdIsNull" resultMap="PerformanceMap">
        select
            *
        from
            performance_tb pt
            left outer join performance_region_tb prt on (prt.performance_region_id = pt.performance_region_id)
            left outer join performance_state_tb pst on (pst.performance_state_id = pt.performance_state_id)
            left outer join ticketing_url_tb tut on (tut.performance_id = pt.performance_id)
        where
            pt.performance_api_id is null;
    </select>

    <select id="findByPerformanceApiIdIsNotNull" resultMap="PerformanceMap">
        select
            *
        from
            performance_tb pt
            left outer join performance_region_tb prt on (prt.performance_region_id = pt.performance_region_id)
            left outer join performance_state_tb pst on (pst.performance_state_id = pt.performance_state_id)
            left outer join ticketing_url_tb tut on (tut.performance_id = pt.performance_id)
        where
            pt.performance_api_id is not null;
    </select>

    <insert id="insert" keyProperty="performanceId" useGeneratedKeys="true">
    insert ignore into performance_tb (
        performance_id,
        performance_region_id,
        performance_api_id,
        performance_title,
        performance_cast,
        performance_poster_url,
        performance_start_date,
        performance_end_date,
        performance_venue,
        performance_state_id,
        performance_last_modified,
        is_foreign,
        is_festival,
        updated_at
        )
    values (
        default,
        #{performanceRegion.performanceRegionId},
        #{performanceApiId},
        #{performanceTitle},
        #{performanceCast},
        #{performancePosterUrl},
        #{performanceStartDate},
        #{performanceEndDate},
        #{performanceVenue},
        #{performanceState.performanceStateId},
        #{performanceLastModified},
        #{isForeign},
        #{isFestival},
        #{updatedAt}
      )
  </insert>

  <insert id="insertMany" keyProperty="performanceId" parameterType="java.util.List" useGeneratedKeys="true">
    insert ignore into performance_tb (
      performance_id,
      performance_region_id,
      performance_api_id,
      performance_title,
      performance_cast,
      performance_poster_url,
      performance_start_date,
      performance_end_date,
      performance_venue,
      performance_state_id,
      performance_last_modified,
      is_foreign,
      is_festival,
      updated_at
    )
    values
      <foreach collection="list" index="index" item="performance" separator=",">
        (
        default,
        #{performance.performanceRegion.performanceRegionId},
        #{performance.performanceApiId},
        #{performance.performanceTitle},
        #{performance.performanceCast},
        #{performance.performancePosterUrl},
        #{performance.performanceStartDate},
        #{performance.performanceEndDate},
        #{performance.performanceVenue},
        #{performance.performanceState.performanceStateId},
        #{performance.performanceLastModified},
        #{performance.isForeign},
        #{performance.isFestival},
        #{performance.updatedAt}
        )
      </foreach>
  </insert>

    <insert id="insertOrUpdateComment">
        insert into performance_comment_tb (
            <if test="performanceCommentId != null">
                performance_comment_id,
            </if>
            user_id, performance_id, content, created_at, deleted_at )
        values
        (
            <if test="performanceCommentId != null">
                #{performanceCommentId},
            </if>
            #{userId}, #{performanceId}, #{content}, now(), null)
        <if test="performanceCommentId != null">
            on duplicate key update
                content = #{content}
        </if>
    </insert>

    <select id="findCommentsByPerformanceId" resultMap="PerformanceCommentMap">
        select
            pct.performance_comment_id,
            pct.user_id as pct_user_id,
            pct.performance_id as pct_performance_id,
            pct.content,
            pct.created_at as pct_created_at,
            pct.deleted_at as pct_deleted_at,

            ut.user_id,
            ut.user_nickname,
            ut.user_profile_img_url
        from
            performance_comment_tb pct
            left outer join user_tb ut on (pct.user_id = ut.user_id)
        where
            pct.performance_id = #{performanceId}
    </select>

    <select id="findAllPerformanceApiId" resultType="java.lang.String">
        select
            performance_api_id
        from
            performance_tb
        where
            performance_api_id is not null
    </select>

    <update id="updateCommentDeletedAtById">
        update performance_comment_tb
        set
            deleted_at = now()
        where
            performance_comment_id = #{performanceCommentId}
    </update>

</mapper>