<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.festspot.dev.domain.post.PostMapper">

    <resultMap id="PostMap" type="com.festspot.dev.domain.post.Post">
        <id property="postId" column="post_id" />
        <result property="userId" column="user_id" />
        <result property="postCategoryId" column="post_category_id" />
        <result property="postTitle" column="post_title" />
        <result property="postContent" column="post_content" />
        <result property="viewCount" column="view_count" />
        <result property="likeCount" column="like_count" />
        <result property="commentCount" column="comment_count" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />

        <association property="user" resultMap="UserMap" />
        <association property="postCategory" resultMap="PostCategoryMap" />
        <collection property="postImgs" javaType="list" resultMap="PostImgMap" />
    </resultMap>

    <resultMap id="UserMap" type="com.festspot.dev.domain.user.User">
        <id property="userId" column="ut_user_id" />
        <result property="userNickName" column="ut_user_nickname" />
        <result property="userProfileImgUrl" column="ut_user_profile_img_url" />
    </resultMap>

    <resultMap id="PostImgMap" type="com.festspot.dev.domain.postImg.PostImg">
        <id property="postImgId" column="post_img_id" />
        <result property="seq" column="seq" />
        <result property="postId" column="post_id" />
        <result property="postImgUrl" column="post_img_url" />
    </resultMap>

    <resultMap id="PostCategoryMap" type="com.festspot.dev.domain.postCategory.PostCategory">
        <id property="postCategoryId" column="post_category_id" />
        <result property="postCategoryKey" column="post_category_key"/>
        <result property="postCategoryName" column="post_category_name"/>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="postId">
        insert into post_tb
        values (default, #{userId}, #{postCategoryId}, #{postTitle}, #{postContent}, #{viewCount}, #{likeCount}, #{commentCount}, now(), null)
    </insert>

    <update id="increaseViewCount">
        update post_tb
        set view_count = view_count + 1
        where post_id = #{postId}
    </update>

    <select id="findByPostId" resultMap="PostMap">
        select
            pt.post_id,
            pt.user_id,
            pt.post_category_id,
            pt.post_title,
            pt.post_content,
            pt.view_count,
            pt.like_count,
            pt.comment_count,
            pt.created_at,
            pt.updated_at,

            ut.user_id as ut_user_id,
            ut.user_nickname as ut_user_nickname,
            ut.user_profile_img_url as ut_user_profile_img_url,

            pit.post_img_id,
            pit.post_img_url,
            pit.seq,

            pcat.post_category_id,
            pcat.post_category_key,
            pcat.post_category_name
        from
            post_tb pt
            left outer join user_tb ut on(ut.user_id = pt.user_id)
            left outer join post_img_tb pit on(pit.post_id = pt.post_id)
            left outer join post_category_tb pcat on(pcat.post_category_id = pt.post_category_id)
        where
            pt.post_id = #{postId}
    </select>

  <select id="findAll" resultMap="PostMap">
      select
        *
      from
        post_tb pt
        left outer join post_img_tb pit on (pt.post_id = pit.post_id)
        left outer join post_like_tb plt on (pt.post_id = plt.post_id)
        left outer join post_category_tb pcat on (pt.post_category_id = pcat.post_category_id)
      limit #{startIndex}, #{size}
  </select>

    <select id="countAll" resultType="java.lang.Double">
        select
            count(*)
        from
            post_tb
    </select>

    <select id="findByCategoryId" resultMap="PostMap">
        select
            *
        from (
            select
                dense_rank() over(order by pt.created_at desc, pt.post_id desc) as post_number,
                pt.post_id,
                pt.user_id,
                pt.post_category_id,
                pt.post_title,
                pt.post_content,
                pt.view_count,
                pt.comment_count,
                pt.created_at,
                pt.updated_at,

                ut.user_id as ut_user_id,
                ut.user_nickname,
                ut.user_profile_img_url,

                pcat.post_category_id as pcat_post_category_id,
                pcat.post_category_key,
                pcat.post_category_name,

                pit.seq,
                pit.post_id as pit_post_it,
                pit.post_img_url
            from
                post_tb pt
                left outer join user_tb ut on (ut.user_id = pt.user_id)
                left outer join post_img_tb pit on (pt.post_id = pit.post_id)
                left outer join post_like_tb plt on (pt.post_id = plt.post_id)
                left outer join post_category_tb pcat on (pt.post_category_id = pcat.post_category_id)
            ) post
        where
            post_category_id = #{categoryId} and
            post_number between #{startIndex} and #{endIndex};
    </select>

    <select id="countByCategoryId" resultType="java.lang.Double">
        select
            count(*)
        from
            post_tb
        where
            post_category_id = #{categoryId}
    </select>


    <select id="findByOption" resultMap="PostMap">
        select
            pt.post_id,
            pt.user_id,
            pt.post_category_id,
            pt.post_title,
            pt.post_content,
            pt.view_count,
            pt.like_count,
            pt.comment_count,
            pt.created_at,
            pt.updated_at,

            ut.user_id,
            ut.user_login_id,
            ut.user_email,
            ut.user_nickname,
            ut.user_profile_img_url,
            ut.created_at,
            ut.provider,
            ut.provider_id,
            ut.deleted_at,

            pct.post_category_key,
            pct.post_category_name,

            pit.post_img_id,
            pit.post_id,
            pit.post_img_url,
            pit.seq,

            pmt.post_comment_id,
            pmt.post_id,
            pmt.user_id,
            pmt.comment_content,
            pmt.like_count,
            pmt.comment_level,
            pmt.created_at,
            pmt.parent_comment_id,
            pmt.deleted_at,
            pmt.updated_at,

            ifnull(clc.like_count, 0) as like_count,
            ifnull(cc.comments_count, 0) as comments_count
        from
            post_tb pt
            left outer join user_tb ut on(ut.user_id = pt.user_id)
            left outer join post_img_tb pit on(pit.post_id = pt.post_id)
            left outer join post_category_tb pct on(pct.post_category_id = pt.post_category_id)
            left outer join post_comment_tb pmt on(pmt.post_id = pt.post_id)
            left outer join post_like_tb plt on(plt.post_id = pt.post_id)
            left outer join (select post_id, count(*) as comments_count
                            from post_comment_tb
                            group by post_id) cc on(cc.post_id = pt.post_id)
            left outer join (select post_id, count(*) as like_count
                            from post_like_tb
                            group by post_id) clc on(clc.post_id = pt.post_id)
            where
                pt.post_category_id = #{postCategoryId}
                and pt.post_id = #{postId}
    </select>


</mapper>