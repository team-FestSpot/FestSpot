<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.festspot.dev.domain.post.PostMapper">

    <resultMap id="PostMap" type="com.festspot.dev.domain.post.Post">
        <id property="postId" column="post_id" />
        <result property="userId" column="user_id" />
        <result property="postCategoryId" column="post_category_id" />
        <result property="postTitle" column="post_title" />
        <result property="postContent" column="post_content" />
        <result property="viewCount" column="view_count" />
        <result property="likeCount" column="like_count" />
        <result property="isLike" column="is_like" />
        <result property="commentCount" column="comment_count" />
        <result property="isLike" column="isLike" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />

        <association property="user" resultMap="UserMap" />
        <association property="postCategory" resultMap="PostCategoryMap" />
        <collection property="postImgs" javaType="list" resultMap="PostImgMap" notNullColumn="pit_post_id" />
    </resultMap>

    <resultMap id="UserMap" type="com.festspot.dev.domain.user.User">
        <id property="userId" column="user_id" />
        <result property="userNickName" column="user_nickname" />
        <result property="userProfileImgUrl" column="user_profile_img_url" />
    </resultMap>

    <resultMap id="PostImgMap" type="com.festspot.dev.domain.postImg.PostImg">
        <id property="postImgId" column="post_img_id" />
        <result property="seq" column="seq" />
        <result property="postId" column="post_id" />
        <result property="postImgUrl" column="post_img_url" />
    </resultMap>

    <resultMap id="PostCategoryMap" type="com.festspot.dev.domain.postCategory.PostCategory">
        <id property="postCategoryId" column="post_category_id" />
        <result property="postCategoryKey" column="post_category_key"/>
        <result property="postCategoryName" column="post_category_name"/>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="postId">
        insert into post_tb
        values (default, #{userId}, #{postCategoryId}, #{postTitle}, #{postContent}, #{viewCount}, #{commentCount}, now(), null)
    </insert>

    <update id="increaseViewCount">
        update post_tb
        set view_count = view_count + 1
        where post_id = #{postId}
    </update>
  <update id="update">
    update post_tb
    set
      post_category_id = #{postCategoryId},
      post_title = #{postTitle},
      post_content = #{postContent},
      updated_at = now()
    where
      post_id = #{postId}
  </update>

  <select id="findById" resultMap="PostMap">
      select
        *
      from (
        select
          dense_rank() over(order by pt.created_at desc, pt.post_id desc) as post_number,
          pt.post_id,
          pt.user_id,
          pt.post_category_id,
          pt.post_title,
          pt.post_content,
          pt.view_count,
          pt.comment_count,
          pt.created_at,
          pt.updated_at,

          ut.user_id as ut_user_id,
          ut.user_nickname,
          ut.user_profile_img_url,

          pit.post_img_id,
          pit.seq,
          pit.post_id as pit_post_id,
          pit.post_img_url,

          <if test="userId != null">
            ifnull(plt.post_like_id, 0) as is_like,
          </if>
          ifnull(plct.like_count, 0) as like_count,

          pcat.post_category_id as pcat_post_category_id,
          pcat.post_category_key,
          pcat.post_category_name
        from
          post_tb pt
          left outer join user_tb ut on (ut.user_id = pt.user_id)
          left outer join post_img_tb pit on (pt.post_id = pit.post_id)
          <if test="userId != null">
            left outer join post_like_tb plt on (pt.post_id = plt.post_id and plt.user_id = #{userId})
          </if>
          left outer join (select post_id, count(*) as like_count from post_like_tb group by post_id) plct on (plct.post_id = pt.post_id)
          left outer join post_category_tb pcat on (pt.post_category_id = pcat.post_category_id)
        ) post
      where
        post_id = #{postId}
    </select>

  <select id="findAll" resultMap="PostMap">
    select
      *
        from (
          select
            dense_rank() over(order by pt.created_at desc, pt.post_id desc) as post_number,
            pt.post_id,
            pt.user_id,
            pt.post_category_id,
            pt.post_title,
            pt.post_content,
            pt.view_count,
            pt.comment_count,
            pt.created_at,
            pt.updated_at,

            ut.user_id as ut_user_id,
            ut.user_nickname,
            ut.user_profile_img_url,

            pit.post_img_id,
            pit.seq,
            pit.post_id as pit_post_id,
            pit.post_img_url,

            <if test="userId != null">
              ifnull(plt.post_like_id, 0) as is_like,
            </if>
            ifnull(plct.like_count, 0) as like_count,

            pcat.post_category_id as pcat_post_category_id,
            pcat.post_category_key,
            pcat.post_category_name
          from
            post_tb pt
            left outer join user_tb ut on (ut.user_id = pt.user_id)
            left outer join post_img_tb pit on (pt.post_id = pit.post_id)
            <if test="userId != null">
              left outer join post_like_tb plt on (pt.post_id = plt.post_id and pt.user_id = #{userId})
            </if>
            left outer join (select post_id, count(*) as like_count from post_like_tb group by post_id) plct on (plct.post_id = pt.post_id)
            left outer join post_category_tb pcat on (pt.post_category_id = pcat.post_category_id)
        ) post
    where
      post_number between #{startIndex} and #{endIndex};
  </select>



    <select id="findByCategoryId" resultMap="PostMap">
      select
      *
      from (
        select
          dense_rank() over(order by pt.created_at desc, pt.post_id desc) as post_number,
          pt.post_id,
          pt.user_id,
          pt.post_category_id,
          pt.post_title,
          pt.post_content,
          pt.view_count,
          pt.comment_count,
          pt.created_at,
          pt.updated_at,

          ut.user_id as ut_user_id,
          ut.user_nickname,
          ut.user_profile_img_url,

          pit.post_img_id,
          pit.seq,
          pit.post_id as pit_post_id,
          pit.post_img_url,

          <if test="userId != null">
            ifnull(plt.post_like_id, 0) as is_like,
          </if>
          ifnull(plct.like_count, 0) as like_count,

          pcat.post_category_id as pcat_post_category_id,
          pcat.post_category_key,
          pcat.post_category_name
        from
          post_tb pt
          left outer join user_tb ut on (ut.user_id = pt.user_id)
          left outer join post_img_tb pit on (pt.post_id = pit.post_id)
          <if test="userId != null">
            left outer join post_like_tb plt on (pt.post_id = plt.post_id and pt.user_id = #{userId})
          </if>
          left outer join (select post_id, count(*) as like_count from post_like_tb group by post_id) plct on (plct.post_id = pt.post_id)
          left outer join post_category_tb pcat on (pt.post_category_id = pcat.post_category_id)
        where
          pt.post_category_id = #{categoryId}
        ) post
      where
        post_number between #{startIndex} and #{endIndex};


    </select>

    <select id="countAll" resultType="java.lang.Double">
        select
        count(*)
        from
        post_tb
    </select>

    <select id="countByCategoryId" resultType="java.lang.Double">
        select
            count(*)
        from
            post_tb
        where
            post_category_id = #{categoryId}
    </select>


</mapper>