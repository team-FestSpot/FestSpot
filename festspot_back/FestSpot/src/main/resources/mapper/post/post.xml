<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.festspot.dev.domain.post.PostMapper">

    <resultMap id="PostMap" type="com.festspot.dev.domain.post.Post">
        <id property="postId" column="post_id" />
        <result property="userId" column="user_id" />
        <result property="postCategoryId" column="post_category_id" />
        <result property="postTitle" column="post_title" />
        <result property="postContent" column="post_content" />
        <result property="allowComments" column="allow_comments" />
        <result property="viewCount" column="view_count" />
        <result property="commentCount" column="comment_count" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />

        <association property="user" resultMap="UserMap" />
        <association property="postCategory" resultMap="PostCategoryMap" />
        <collection property="postImgs" javaType="list" resultMap="PostImgMap" />
        <collection property="postComments" javaType="list" resultMap="PostCommentMap" />
    </resultMap>

    <resultMap id="UserMap" type="com.festspot.dev.domain.user.User">
        <id property="userId" column="user_id" />
        <result property="userNickName" column="user_nickname" />
        <result property="userProfileImgUrl" column="user_profile_img_url" />
    </resultMap>

    <resultMap id="PostImgMap" type="com.festspot.dev.domain.postImg.PostImg">
        <id property="postImgId" column="post_img_id" />
        <result property="seq" column="seq" />
        <result property="postId" column="post_id" />
        <result property="postImgUrl" column="post_img_url" />
    </resultMap>

    <resultMap id="PostCommentMap" type="com.festspot.dev.domain.post.PostComment">
        <id property="postCommentId" column="post_comment_id" />
        <result property="postId" column="post_id"/>
        <result property="userId" column="user_id"/>
        <result property="commentContent" column="comment_content"/>
        <result property="createdAt" column="created_at"/>
        <result property="parentCommentId" column="parent_comment_id"/>
        <result property="deletedAt" column="deleted_at"/>
        <result property="updatedAt" column="updated_at"/>
        <association property="user" resultMap="UserMap"/>
    </resultMap>

    <resultMap id="PostCategoryMap" type="com.festspot.dev.domain.postCategory.PostCategory">
        <id property="postCategoryId" column="post_category_id" />
        <result property="postCategoryKey" column="post_category_key"/>
        <result property="postCategoryName" column="post_category_name"/>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="postId">
        insert into post_tb
        values (default, #{userId}, #{postTitle}, #{postContent}, #{allowComments}, now())
    </insert>

    <select id="findByPostId" resultType="com.festspot.dev.domain.post.Post">
        select
            pt.post_id,
            pt.user_id,
            pt.post_category_id,
            pt.post_title,
            pt.post_content,
            pt.view_count,
            pt.like_count,
            pt.comment_count,
            pt.created_at,

            ut.user_id,
            ut.user_nickname,
            ut.user_profile_img_url,

            pit.post_img_url,
            pit.seq,

            ifnull(plt.post_like_id, 0) as is_like
        from
            post_tb pt
            left outer join user_tb ut on(ut.user_id = pt.user_id)
            left outer join post_img_tb pit on(pit.post_id = pt.post_id)
            left outer join post_like_tb plt on(plt.post_id = pt.post_id and plt.user_id = #{userId})
            <if test="userId != null">
                plt.user_id = #{userId}
            </if>
        where
            pt.post_id = #{postId}
    </select>

  <select id="findAll" resultType="com.festspot.dev.domain.post.Post">
      select
        *
      from
        post_tb pt
        left outer join post_img_tb pit on (pt.post_id = pit.post_id)
        left outer join post_comment_tb pcot on (pt.post_id = pcot.post_id)
        left outer join post_like_tb plt on (pt.post_id = plt.post_id)
        left outer join post_category_tb pcat on (pt.post_category_id = pcat.post_category_id)
      limit #{startIndex}, #{size}
  </select>

    <select id="countAll" resultType="java.lang.Double">
        select
            count(*) / #{size}
        from
            post_tb
    </select>

    <select id="findByCategoryId" resultType="com.festspot.dev.domain.post.Post">
        select
            *
        from
            post_tb pt
            left outer join post_img_tb pit on (pt.post_id = pit.post_id)
            left outer join post_comment_tb pcot on (pt.post_id = pcot.post_id)
            left outer join post_like_tb plt on (pt.post_id = plt.post_id)
            left outer join post_category_tb pcat on (pt.post_category_id = pcat.post_category_id)
        where
            pt.post_category_id = #{categoryId}
        limit #{startIndex}, #{size}
    </select>

    <select id="countByCategoryId" resultType="java.lang.Double">
        select
            count(*) / #{size}
        from
            post_tb
        where
            post_category_id = #{categoryId}
    </select>


</mapper>