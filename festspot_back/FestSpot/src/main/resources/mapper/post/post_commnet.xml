<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.festspot.dev.domain.post.PostCommentMapper">

    <resultMap id="PostCommentMap" type="com.festspot.dev.domain.post.PostComment">
        <id property="postCommentId" column="post_comment_id" />
        <result property="postId" column="post_id" />
        <result property="parentCommentId" column="parent_comment_id" />
        <result property="userId" column="user_id" />
        <result property="commentContent" column="comment_content" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />
        <result property="deletedAt" column="deleted_at" />
        <association property="user" resultMap="UserMap" />
    </resultMap>

    <resultMap id="UserMap" type="com.festspot.dev.domain.user.User">
        <id property="userId" column="user_id" />
        <result property="userNickName" column="user_nickname" />
        <result property="userProfileImgUrl" column="user_profile_img_url" />
    </resultMap>

    <insert id="insertComment" useGeneratedKeys="true" keyProperty="postCommentId">
        insert into post_comment_tb
        values (default, #{postId}, #{userId}, #{commentContent}, #{parentCommentId}, now(), null, null)
    </insert>

    <update id="updateComment">
        update post_comment_tb
        set comment_content = #{commentContent}
        where post_comment_id = #{postCommentId}
        and post_id = #{postId}
        and user_id = #{userId}
    </update>

    <delete id="deleteComment">
        delete from post_comment_tb
        where post_comment_id = #{postCommentId}
        and post_id = #{postId}
        and user_id = #{userId}
    </delete>

    <select id="getCountByPostId" resultType="java.lang.Integer">
        select
            *
        from
            post_comment_tb
        where
            post_id = #{postId}
    </select>

    <select id="findByPostId" resultType="com.festspot.dev.domain.post.PostComment">
        select
            pmt.post_comment_id,
            pmt.post_id,
            pmt.user_id,
            pmt.comment_content,
            pmt.like_count,
            pmt.comment_level,
            pmt.created_at,
            pmt.parent_comment_id,
            pmt.deleted_at,
            pmt.updated_at,

            ut.user_id,
            ut.user_login_id,
            ut.user_email,
            ut.user_nickname,
            ut.user_profile_img_url,
            ut.created_at,
            ut.provider,
            ut.provider_id,
            ut.deleted_at
        from
            post_comment_tb pmt
            left outer join user_tb ut on(ut.user_id = pmt.user_id)
        where
            ut.user_id = #{userId} and
            pt.post_id = #{postId}

    </select>

    <select id="selectComments" resultMap="PostCommentMap">
        select
            *
<!--            pmt.post_comment_id,-->
<!--            pmt.post_id,-->
<!--            pmt.user_id,-->
<!--            ut.user_nickname,-->
<!--            pmt.comment_content,-->
<!--            pmt.created_at,-->
<!--            pmt.updated_at-->
        from
            post_comment_tb pmt
            left outer join user_tb ut on (ut.user_id and pmt.user_id)
        where
            pmt.post_id = #{postId}
        order by pmt.post_comment_id DESC
    </select>
</mapper>